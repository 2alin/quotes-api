<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit quote</title>
    <style>
      #quote-id {
        width: 80px;
      }
      #update-quote-form {
        width: 500px;
      }
      .row {
        display: flex;
      }
      .row.submit {
        justify-content: end;
      }
      #author {
        width: 100%;
      }
      #quote {
        width: 100%;
        height: 100px;
      }
      label {
        display: inline-block;
        width: 100px;
        padding: 0 0.5rem;
        text-align: end;
      }
    </style>
  </head>
  <body>
    <h1>Edit quote</h1>
    <form action="" id="get-quote-form">
      <label for="quoteId">Quote ID:</label>
      <input type="number" id="quote-id" required />
      <input type="submit" value="Get Quote" />
    </form>
    <form action="" method="POST" id="update-quote-form" hidden>
      <p class="row">
        <label for="quote">Quote: </label>
        <textarea name="quote" id="quote" maxlength="1000" required></textarea>
      </p>
      <p class="row">
        <label for="author">Author: </label>
        <input type="text" name="author" id="author" maxlength="200" required />
      </p>
      <p class="row submit">
        <input type="submit" value="Update" />
      </p>
    </form>
    <footer>
      <p><button id="go-back-button" hidden>Go back</button></p>
      <p id="display-response"></p>
    </footer>

    <script>
      const serverUrl = new URL(
        window.location.pathname.replace("public/edit-quote.html", ""),
        window.location.origin
      );
      const getQuoteForm = document.getElementById("get-quote-form");
      const updateQuoteForm = document.getElementById("update-quote-form");
      const goBackButton = document.getElementById("go-back-button");
      const displayResponse = document.getElementById("display-response");

      getQuoteForm.addEventListener("submit", async () => {
        event.preventDefault();

        const request = new Request(
          serverUrl + `quotes/${getQuoteForm["quote-id"].value}`,
          {
            method: "GET",
          }
        );

        const result = await fetch(request);
        const json = await result.json();

        if (json.error) {
          updateQuoteForm.toggleAttribute("hidden", true);
          displayResponse.textContent = json.error;
          return;
        }

        const { author, quote } = json.data;

        updateQuoteForm.quote.value = quote;
        updateQuoteForm.author.value = author;
        displayResponse.textContent = "";
        getQuoteForm.toggleAttribute("hidden", true);
        updateQuoteForm.toggleAttribute("hidden", false);
        goBackButton.toggleAttribute("hidden", false);
      });

      updateQuoteForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        const request = new Request(
          serverUrl + `quotes/${getQuoteForm["quote-id"].value}`,
          {
            method: "PUT",
            headers: {
              Accept: "application/json",
              "Content-type": "application/json",
            },
            body: JSON.stringify({
              quote: updateQuoteForm.quote.value.trim(),
              author: updateQuoteForm.author.value.trim(),
            }),
          }
        );

        try {
          const result = await fetch(request);
          const json = await result.json();
          displayResponse.textContent = JSON.stringify(json);
        } catch (err) {
          displayResponse.textContent = err;
        }
      });

      goBackButton.addEventListener("click", () => {
        displayResponse.textContent = "";
        getQuoteForm.toggleAttribute("hidden", false);
        updateQuoteForm.toggleAttribute("hidden", true);
        goBackButton.toggleAttribute("hidden", true);
      });
    </script>
  </body>
</html>
